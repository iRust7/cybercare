<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - CyberCare</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/animations.css">
    <style>
        body {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            min-height: 100vh;
        }

        .nav-dropdown {
            position: relative;
        }

        .user-menu-trigger {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .user-menu-trigger:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(212, 175, 55, 0.3);
        }

        .user-dropdown-menu {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            min-width: 200px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            z-index: 1000;
        }

        .user-dropdown-menu.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            color: #334155;
            text-decoration: none;
            transition: all 0.2s;
            cursor: pointer;
        }

        .dropdown-item:first-child {
            border-radius: 12px 12px 0 0;
        }

        .dropdown-item:last-child {
            border-radius: 0 0 12px 12px;
            border-top: 1px solid #e2e8f0;
        }

        .dropdown-item:hover {
            background: #f8fafc;
            color: #1e40af;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .stat-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .stat-icon {
            font-size: 32px;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 800;
            color: #1e3a8a;
            margin-bottom: 4px;
        }

        .stat-label {
            color: #64748b;
            font-size: 14px;
            font-weight: 600;
        }

        .section-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid #e2e8f0;
        }

        .section-title {
            font-size: 20px;
            font-weight: 700;
            color: #1e3a8a;
        }

        .btn-export {
            padding: 10px 20px;
            background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-export:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(30, 64, 175, 0.4);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            overflow-x: auto;
            display: block;
        }

        .data-table thead {
            background: #f8fafc;
        }

        .data-table th {
            padding: 12px;
            text-align: left;
            font-weight: 700;
            color: #64748b;
            font-size: 12px;
            text-transform: uppercase;
            border-bottom: 2px solid #e2e8f0;
            white-space: nowrap;
        }

        .data-table tbody {
            display: table;
            width: 100%;
        }

        .data-table td {
            padding: 16px 12px;
            border-bottom: 1px solid #e2e8f0;
            color: #334155;
            font-size: 14px;
        }

        .data-table tbody tr:hover {
            background: #f8fafc;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-badge.completed {
            background: #d1fae5;
            color: #065f46;
        }

        .status-badge.in-progress {
            background: #fef3c7;
            color: #92400e;
        }

        .status-badge.not-started {
            background: #f1f5f9;
            color: #475569;
        }

        .progress-bar-mini {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 100px;
            overflow: hidden;
        }

        .progress-fill-mini {
            height: 100%;
            background: linear-gradient(90deg, #1e40af, #d4af37);
            border-radius: 100px;
        }

        .user-avatar-small {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 14px;
        }

        .access-denied {
            text-align: center;
            padding: 100px 20px;
        }

        .access-denied-icon {
            font-size: 80px;
            margin-bottom: 24px;
        }

        .access-denied-title {
            font-size: 32px;
            font-weight: 700;
            color: #1e3a8a;
            margin-bottom: 12px;
        }

        .access-denied-text {
            color: #64748b;
            font-size: 18px;
            margin-bottom: 32px;
        }
    </style>
</head>
<body class="page-transition">
    <nav class="app-nav">
        <div class="nav-container">
            <div class="logo">
                <span class="logo-icon">üõ°Ô∏è</span>
                <span class="logo-text">CyberCare</span>
            </div>
            <div class="nav-menu">
                <a href="dashboard.html" class="nav-item">
                    <span class="nav-icon">üè†</span>
                    <span>Dashboard</span>
                </a>
                <a href="materials.html" class="nav-item">
                    <span class="nav-icon">üìö</span>
                    <span>Materi</span>
                </a>
                <a href="quiz.html" class="nav-item">
                    <span class="nav-icon">üéØ</span>
                    <span>Kuis</span>
                </a>
                <a href="simulation.html" class="nav-item">
                    <span class="nav-icon">‚ö†Ô∏è</span>
                    <span>Simulasi</span>
                </a>
                <a href="tips.html" class="nav-item">
                    <span class="nav-icon">üí°</span>
                    <span>Tips</span>
                </a>
                <a href="admin.html" class="nav-item active">
                    <span class="nav-icon">‚öôÔ∏è</span>
                    <span>Admin</span>
                </a>
            </div>
            <div class="nav-dropdown">
                <div class="user-menu-trigger" onclick="toggleUserMenu()">
                    <div class="user-avatar" id="userAvatar">A</div>
                    <div class="user-info">
                        <div class="user-name" id="userName">Admin</div>
                        <div class="user-business" id="userBusiness">CyberCare</div>
                    </div>
                    <span>‚ñº</span>
                </div>
                <div class="user-dropdown-menu" id="userDropdown">
                    <a href="dashboard.html" class="dropdown-item">
                        <span>üè†</span>
                        <span>Dashboard</span>
                    </a>
                    <div class="dropdown-item" onclick="handleLogout()">
                        <span>üö™</span>
                        <span>Logout</span>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <main class="app-main">
        <div class="main-container">
            <div id="accessDenied" style="display: none;">
                <div class="access-denied">
                    <div class="access-denied-icon">üö´</div>
                    <div class="access-denied-title">Akses Ditolak</div>
                    <div class="access-denied-text">Halaman ini hanya dapat diakses oleh administrator</div>
                    <button class="btn-export" onclick="window.location.href='dashboard.html'">Kembali ke Dashboard</button>
                </div>
            </div>

            <div id="adminContent" style="display: none;">
                <header class="page-header">
                    <div class="header-content">
                        <h1 class="page-title">‚öôÔ∏è Admin Dashboard</h1>
                        <p class="page-subtitle">Kelola pengguna dan pantau aktivitas platform</p>
                    </div>
                </header>

                <div class="stats-grid card-enter">
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-label">Total Pengguna</div>
                            <div class="stat-icon">üë•</div>
                        </div>
                        <div class="stat-value" id="totalUsers">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-label">Total Materi</div>
                            <div class="stat-icon">üìö</div>
                        </div>
                        <div class="stat-value" id="totalMaterials">5</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-label">Total Kuis</div>
                            <div class="stat-icon">üéØ</div>
                        </div>
                        <div class="stat-value" id="totalQuizzes">5</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-label">Rata-rata Completion</div>
                            <div class="stat-icon">üìä</div>
                        </div>
                        <div class="stat-value"><span id="avgCompletion">0</span>%</div>
                    </div>
                </div>

                <div class="section-card card-enter-1">
                    <div class="section-header">
                        <h2 class="section-title">üë• Data Pengguna</h2>
                        <button class="btn-export" onclick="exportUsersData()">üì• Export Data</button>
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Pengguna</th>
                                    <th>Email</th>
                                    <th>Bisnis</th>
                                    <th>Level</th>
                                    <th>XP</th>
                                    <th>Materi Selesai</th>
                                    <th>Kuis Lulus</th>
                                    <th>Progress</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <!-- Users data loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="section-card card-enter-2">
                    <div class="section-header">
                        <h2 class="section-title">üìö Materi Pembelajaran</h2>
                        <button class="btn-export" onclick="exportMaterialsData()">üì• Export Data</button>
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Judul Materi</th>
                                    <th>Kategori</th>
                                    <th>Durasi</th>
                                    <th>Level</th>
                                    <th>Total Selesai</th>
                                </tr>
                            </thead>
                            <tbody id="materialsTableBody">
                                <!-- Materials data loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="section-card card-enter-3">
                    <div class="section-header">
                        <h2 class="section-title">üéØ Hasil Kuis</h2>
                        <button class="btn-export" onclick="exportQuizResults()">üì• Export Data</button>
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Pengguna</th>
                                    <th>Kuis</th>
                                    <th>Skor</th>
                                    <th>Status</th>
                                    <th>Tanggal</th>
                                </tr>
                            </thead>
                            <tbody id="quizResultsTableBody">
                                <!-- Quiz results loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="js/main.js"></script>
    <script src="js/auth.js"></script>
    <script>
        function toggleUserMenu() {
            const dropdown = document.getElementById("userDropdown");
            dropdown.classList.toggle("show");
        }

        document.addEventListener("click", function(e) {
            if (!e.target.closest(".nav-dropdown")) {
                document.getElementById("userDropdown").classList.remove("show");
            }
        });

        async function checkAdminAccess() {
            const user = getCurrentUser();
            if (!user) {
                window.location.href = 'login.html';
                return false;
            }

            document.getElementById("userName").textContent = user.name;
            document.getElementById("userBusiness").textContent = user.businessName;
            document.getElementById("userAvatar").textContent = user.avatar || user.name.charAt(0);

            if (user.role !== "admin") {
                document.getElementById("accessDenied").style.display = "block";
                document.getElementById("adminContent").style.display = "none";
                return false;
            }

            document.getElementById("accessDenied").style.display = "none";
            document.getElementById("adminContent").style.display = "block";
            return true;
        }

        async function loadAdminData() {
            const hasAccess = await checkAdminAccess();
            if (!hasAccess) return;

            // Load all users from users_db
            const usersDB = JSON.parse(localStorage.getItem('users_db') || '[]');
            
            // Load materials and quizzes
            const materials = await loadJSON('materials.json');
            const quizzes = await loadJSON('quizzes.json');

            // Calculate stats
            document.getElementById('totalUsers').textContent = usersDB.length;
            
            if (materials) {
                document.getElementById('totalMaterials').textContent = materials.materials.length;
            }
            
            if (quizzes) {
                document.getElementById('totalQuizzes').textContent = quizzes.quizzes.length;
            }

            // Load users table
            loadUsersTable(usersDB);
            
            // Load materials table
            if (materials) {
                loadMaterialsTable(materials.materials, usersDB);
            }
            
            // Load quiz results
            loadQuizResults(usersDB);
        }

        function loadUsersTable(users) {
            const tbody = document.getElementById('usersTableBody');
            
            let totalCompletion = 0;
            
            tbody.innerHTML = users.map(user => {
                // Get user profile
                const profile = user.id === getCurrentUser().id ? getCurrentUser() : 
                    JSON.parse(localStorage.getItem(`user_${user.id}`) || '{}');
                
                const completedMaterials = profile.completedMaterials || [];
                const quizScores = profile.quizScores || [];
                const passedQuizzes = quizScores.filter(q => q.passed).length;
                const level = profile.level || 1;
                const xp = profile.xp || 0;
                
                const progress = Math.round((completedMaterials.length / 5) * 100);
                totalCompletion += progress;
                
                return `
                    <tr>
                        <td>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div class="user-avatar-small">${user.name.charAt(0)}</div>
                                <div>
                                    <div style="font-weight: 600;">${user.name}</div>
                                    <div style="font-size: 12px; color: #64748b;">${user.role || 'user'}</div>
                                </div>
                            </div>
                        </td>
                        <td>${user.email}</td>
                        <td>${user.businessName}</td>
                        <td><span class="status-badge in-progress">Level ${level}</span></td>
                        <td>${xp} XP</td>
                        <td>${completedMaterials.length}/5</td>
                        <td>${passedQuizzes}/5</td>
                        <td>
                            <div class="progress-bar-mini">
                                <div class="progress-fill-mini" style="width: ${progress}%"></div>
                            </div>
                            <div style="font-size: 12px; color: #64748b; margin-top: 4px;">${progress}%</div>
                        </td>
                    </tr>
                `;
            }).join('');

            // Calculate average completion
            const avgCompletion = users.length > 0 ? Math.round(totalCompletion / users.length) : 0;
            document.getElementById('avgCompletion').textContent = avgCompletion;
        }

        function loadMaterialsTable(materials, users) {
            const tbody = document.getElementById('materialsTableBody');
            
            tbody.innerHTML = materials.map(material => {
                // Count how many users completed this material
                let completedCount = 0;
                users.forEach(user => {
                    const profile = user.id === getCurrentUser().id ? getCurrentUser() : 
                        JSON.parse(localStorage.getItem(`user_${user.id}`) || '{}');
                    if (profile.completedMaterials && profile.completedMaterials.includes(material.id)) {
                        completedCount++;
                    }
                });
                
                return `
                    <tr>
                        <td>${material.id}</td>
                        <td><strong>${material.title}</strong></td>
                        <td><span class="status-badge in-progress">${material.category}</span></td>
                        <td>${material.duration}</td>
                        <td>${material.level}</td>
                        <td>${completedCount} pengguna</td>
                    </tr>
                `;
            }).join('');
        }

        function loadQuizResults(users) {
            const tbody = document.getElementById('quizResultsTableBody');
            let allResults = [];
            
            users.forEach(user => {
                const profile = user.id === getCurrentUser().id ? getCurrentUser() : 
                    JSON.parse(localStorage.getItem(`user_${user.id}`) || '{}');
                
                if (profile.quizScores) {
                    profile.quizScores.forEach(score => {
                        allResults.push({
                            userName: user.name,
                            quizId: score.quizId,
                            score: score.score,
                            passed: score.passed,
                            completedAt: score.completedAt
                        });
                    });
                }
            });
            
            // Sort by date (newest first)
            allResults.sort((a, b) => new Date(b.completedAt) - new Date(a.completedAt));
            
            tbody.innerHTML = allResults.map(result => `
                <tr>
                    <td><strong>${result.userName}</strong></td>
                    <td>Kuis ${result.quizId}</td>
                    <td><strong>${result.score}</strong></td>
                    <td>
                        <span class="status-badge ${result.passed ? 'completed' : 'not-started'}">
                            ${result.passed ? '‚úì Lulus' : '‚úó Tidak Lulus'}
                        </span>
                    </td>
                    <td>${formatDate(result.completedAt)}</td>
                </tr>
            `).join('');
        }

        function exportUsersData() {
            const usersDB = JSON.parse(localStorage.getItem('users_db') || '[]');
            const dataStr = JSON.stringify(usersDB, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `cybercare-users-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            showNotification('Data pengguna berhasil diexport!', 'success');
        }

        function exportMaterialsData() {
            loadJSON('materials.json').then(materials => {
                const dataStr = JSON.stringify(materials, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `cybercare-materials-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                showNotification('Data materi berhasil diexport!', 'success');
            });
        }

        function exportQuizResults() {
            const usersDB = JSON.parse(localStorage.getItem('users_db') || '[]');
            let allResults = [];
            
            usersDB.forEach(user => {
                const profile = user.id === getCurrentUser().id ? getCurrentUser() : 
                    JSON.parse(localStorage.getItem(`user_${user.id}`) || '{}');
                
                if (profile.quizScores) {
                    profile.quizScores.forEach(score => {
                        allResults.push({
                            userName: user.name,
                            userEmail: user.email,
                            quizId: score.quizId,
                            score: score.score,
                            passed: score.passed,
                            completedAt: score.completedAt
                        });
                    });
                }
            });
            
            const dataStr = JSON.stringify(allResults, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `cybercare-quiz-results-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            showNotification('Hasil kuis berhasil diexport!', 'success');
        }

        document.addEventListener('DOMContentLoaded', async function() {
            await checkSession();
            loadAdminData();
        });
    </script>
</body>
</html>
